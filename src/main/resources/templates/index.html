<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>이미지실험실</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #gallery { display:flex; flex-wrap:wrap; gap:12px; margin-top:12px; }
        .thumb { width:160px; border:1px solid #ddd; padding:8px; border-radius:6px; text-align:center; }
        .thumb img { max-width:100%; height:100px; object-fit:cover; display:block; margin-bottom:6px; }
        .actions { margin-top:8px; display:flex; gap:6px; justify-content:center; }
        button { padding:6px 10px; cursor:pointer; }
    </style>
</head>
<body>

<h1>이미지 실험실</h1>

<input id="fileInput" type="file" name="file" accept="image/*" style="display:none" />

<div>
    <button id="uploadBtn">사진 업로드</button>
    <button id="refreshBtn">사진 조회</button>
</div>

<div id="gallery">
    <div th:each="f : ${files}" class="thumb" th:attr="data-id=${f.id}">
        <img th:src="${f.fileUrl}" th:alt="${f.fileName}" />
        <div th:text="${f.fileName}">파일명</div>
        <div class="actions">
            <button type="button" th:attr="data-id=${f.id}" class="deleteBtn">삭제</button>
        </div>
    </div>
</div>
<script>
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const gallery = document.getElementById('gallery');

    // 업로드 버튼 누르면 파일 선택창 열기
    uploadBtn.addEventListener('click', () => fileInput.click());

    // 파일 선택 시 AJAX로 업로드
    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        try {
            const res = await fetch('/api/files', {
                method: 'PUT',
                body: formData
            });

            if (!res.ok) {
                const txt = await res.text();
                alert('업로드 실패: ' + txt);
                return;
            }

            const json = await res.json();
            alert('업로드 성공 (ID: ' + json.id + ')');
            // 새로고침하거나 목록 갱신
            await loadFiles();
        } catch (err) {
            console.error(err);
            alert('업로드 중 오류 발생');
        } finally {
            fileInput.value = ''; // 선택 초기화
        }
    });

    // 사진 조회 버튼
    refreshBtn.addEventListener('click', () => loadFiles());

    // 목록 불러와서 gallery에 렌더링
    async function loadFiles() {
        try {
            const res = await fetch('/api/files');
            if (!res.ok) {
                console.error('파일 목록 불러오기 실패', await res.text());
                return;
            }
            const list = await res.json();
            renderGallery(list);
        } catch (err) {
            console.error(err);
        }
    }

    function renderGallery(list) {
        gallery.innerHTML = '';
        if (!Array.isArray(list) || list.length === 0) {
            gallery.innerHTML = '<div>업로드된 이미지가 없습니다.</div>';
            return;
        }

        list.forEach(item => {
         const id = item.id || item.name || item.fileName; // 유연하게 대응
            const url = item.fileUrl || item.url;
            const name = item.fileName || item.name;

            const div = document.createElement('div');
            div.className = 'thumb';
            div.dataset.id = id;

            const img = document.createElement('img');
            img.src = url;
            img.alt = name || 'image';

            const caption = document.createElement('div');
            caption.textContent = name || '';

            const actions = document.createElement('div');
            actions.className = 'actions';

            const delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.textContent = '삭제';
            delBtn.dataset.id = id;
            delBtn.addEventListener('click', () => deleteFile(id));

            actions.appendChild(delBtn);
            div.appendChild(img);
            div.appendChild(caption);
            div.appendChild(actions);

            gallery.appendChild(div);
        });
    }

    // 파일 삭제 (DELETE)
    async function deleteFile(id) {
        if (!confirm('정말로 삭제하시겠어요?')) return;

        try {
            const res = await fetch('/api/files/' + encodeURIComponent(id), {
                method: 'DELETE'
            });

            if (!res.ok) {
                alert('삭제 실패: ' + await res.text());
                return;
            }

            alert('삭제됨: ' + id);
            await loadFiles();
        } catch (err) {
            console.error(err);
            alert('삭제 중 오류 발생');
        }
    }

    loadFiles();

</script>
</body>
</html>